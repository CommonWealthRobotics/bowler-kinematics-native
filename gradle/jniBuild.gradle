model {
    //noinspection GroovyAssignabilityCheck
    components {
        native_library(JniNativeLibrarySpec) {
            enableCheckTask true
            javaCompileTasks << compileJava
            sources {
                cpp {
                    source {
                        srcDirs 'src/main/native/cpp'
                        include '*.cpp'
                    }

                    exportedHeaders {
                        srcDir 'src/main/native/include'
                        if (project.hasProperty('generatedHeaders')) {
                            srcDir generatedHeaders
                        }

                        include '**/*.h'
                    }
                }
            }

            binaries.all {
                cppCompiler.args "-std=c++17", "-O3", "-flto"
                linker.args "-flto"
            }
        }
    }

    tasks {
        def components = $.components
        def found = false
        components.each {
            if (it in JniNativeLibrarySpec) {
                def binaries = it.binaries.withType(SharedLibraryBinarySpec).each {
                    if (found) {
                        return
                    } else {
                        found = true
                    }

                    test.dependsOn it.tasks.link

                    def filePath = it.tasks.link.linkedFile.get().asFile.parentFile
                    test.systemProperty 'java.library.path', filePath.path + "/"
                    test.environment 'LD_LIBRARY_PATH', filePath.path + "/"
                    // Enable this if you make this a java application
                    //run.systemProperty 'java.library.path', filePath
                    //run.environment 'LD_LIBRARY_PATH', filePath
                }
            }
        }
    }
}
